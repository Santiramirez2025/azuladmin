// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════
// USUARIOS Y AUTENTICACIÓN
// ═══════════════════════════════════════════════════════════

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      Role     @default(VENDEDOR)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents Document[]

  @@index([email])
  @@map("users")
}

enum Role {
  ADMIN
  VENDEDOR
}

// ═══════════════════════════════════════════════════════════
// CLIENTES
// ═══════════════════════════════════════════════════════════

model Client {
  id        String   @id @default(cuid())
  name      String
  dni       String?
  phone     String
  email     String?
  address   String?
  city      String   @default("Villa María")
  province  String   @default("Córdoba")
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  documents Document[]

  @@index([phone])
  @@index([name])
  @@index([createdAt])
  @@map("clients")
}

// ═══════════════════════════════════════════════════════════
// PRODUCTOS
// ═══════════════════════════════════════════════════════════

model Product {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  category    Category @relation(fields: [categoryId], references: [id])
  categoryId  String
  brand       String   @default("PIERO")
  description String?  @db.Text
  warranty    Int      @default(5) // años
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  variants ProductVariant[]

  @@index([categoryId])
  @@index([isActive])
  @@index([sku])
  @@index([name])
  @@map("products")
}

model ProductVariant {
  id        String      @id @default(cuid())
  product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  size      String      // "140x190", "160x200", etc.
  price     Decimal     @db.Decimal(12, 2)
  costPrice Decimal?    @db.Decimal(12, 2)
  source    StockSource @default(CATALOGO)
  stockQty  Int         @default(0)
  minStock  Int         @default(0)
  isActive  Boolean     @default(true)

  documentItems DocumentItem[]

  @@unique([productId, size])
  @@index([productId])
  @@index([source])
  @@index([isActive])
  @@map("product_variants")
}

model Category {
  id       String    @id @default(cuid())
  name     String    @unique
  icon     String?
  order    Int       @default(0)
  products Product[]

  @@index([order])
  @@map("categories")
}

enum StockSource {
  STOCK    // Disponible en showroom - entrega inmediata
  CATALOGO // Pedido a fábrica - 7-10 días hábiles
}

// ═══════════════════════════════════════════════════════════
// DOCUMENTOS (Presupuestos, Recibos, Remitos)
// ═══════════════════════════════════════════════════════════

model Document {
  id              String          @id @default(cuid())
  number          Int             @default(autoincrement())
  type            DocumentType
  status          DocumentStatus  @default(DRAFT)

  // Relaciones
  client          Client          @relation(fields: [clientId], references: [id])
  clientId        String
  createdBy       User            @relation(fields: [userId], references: [id])
  userId          String

  // Fechas
  date            DateTime        @default(now())
  validUntil      DateTime?       // Solo presupuestos (ej: date + 15 días)

  // Items
  items           DocumentItem[]

  // ═══ TOTALES ═══
  subtotal        Decimal         @db.Decimal(12, 2) // Suma de items
  surcharge       Decimal         @default(0) @db.Decimal(12, 2) // Recargo por cuotas
  surchargeRate   Int             @default(0) // Porcentaje (0, 18, 25, 35, 47)
  shippingCost    Decimal         @default(0) @db.Decimal(12, 2)
  total           Decimal         @db.Decimal(12, 2) // subtotal + surcharge + shippingCost

  // ═══ INFORMACIÓN DE PAGO (solo RECIBO) ═══
  paymentMethod   PaymentMethod?  // NUEVO: Enum para método de pago
  paymentType     String?         // "Efectivo", "Transferencia", "Débito", "Crédito", "Cheque", "Mixto"
  installments    Int?            // Número de cuotas (1 = contado, 3, 6, 9, 12)
  
  // Montos de pago
  amountPaid      Decimal?        @db.Decimal(12, 2) // Lo que el cliente pagó
  balance         Decimal?        @db.Decimal(12, 2) // Saldo pendiente (total - amountPaid)
  
  // IMPORTANTE: balance se calcula automáticamente en el backend
  // No modificar directamente, siempre actualizar amountPaid

  // ═══ ENVÍO ═══
  shippingType    String          @default("Sin cargo en Villa María")

  // ═══ METADATA ═══
  observations    String?         @db.Text // Visible para el cliente
  internalNotes   String?         @db.Text // Solo visible internamente

  // ═══ CONVERSIONES ═══
  // Permite rastrear la cadena: Presupuesto → Recibo → Remito
  convertedFrom   Document?       @relation("DocumentConversion", fields: [convertedFromId], references: [id])
  convertedFromId String?
  convertedTo     Document[]      @relation("DocumentConversion")

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([clientId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([date(sort: Desc)]) // Optimizar consultas por fecha
  @@index([number(sort: Desc)]) // Optimizar búsqueda por número
  @@index([type, status]) // Consultas combinadas frecuentes
  @@index([convertedFromId])
  @@index([paymentMethod]) // NUEVO: Índice para consultas por método de pago
  @@map("documents")
}

model DocumentItem {
  id          String          @id @default(cuid())
  document    Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId  String

  // Relación OPCIONAL - permite productos custom sin variante
  variant     ProductVariant? @relation(fields: [variantId], references: [id])
  variantId   String?

  // ═══ SNAPSHOT DE DATOS ═══
  // Siempre se guardan para preservar histórico
  // Estos valores NO cambian aunque se modifique el producto original
  productName String
  productSize String
  unitPrice   Decimal         @db.Decimal(12, 2)
  quantity    Int             @default(1)
  subtotal    Decimal         @db.Decimal(12, 2) // unitPrice * quantity
  source      StockSource     @default(CATALOGO)

  // Flag para productos personalizados (sin variante vinculada)
  isCustom    Boolean         @default(false)

  @@index([documentId])
  @@index([variantId])
  @@map("document_items")
}

enum DocumentType {
  PRESUPUESTO // Cotización inicial
  RECIBO      // Comprobante de venta
  REMITO      // Comprobante de entrega
}

enum DocumentStatus {
  DRAFT     // Borrador (editable)
  SENT      // Enviado al cliente (por WhatsApp, email, etc)
  APPROVED  // Aprobado/Confirmado por el cliente
  COMPLETED // Completado/Entregado (final)
  CANCELLED // Cancelado (no se puede modificar)
  EXPIRED   // Vencido (solo presupuestos después de validUntil)
}

// ═══════════════════════════════════════════════════════════
// NUEVO: ENUM PARA MÉTODOS DE PAGO
// ═══════════════════════════════════════════════════════════

enum PaymentMethod {
  CONTADO   // Pago de contado - 0% recargo
  CUOTAS_3  // 3 cuotas - 18% recargo
  CUOTAS_6  // 6 cuotas - 25% recargo
  CUOTAS_9  // 9 cuotas - 35% recargo
  CUOTAS_12 // 12 cuotas - 47% recargo
}

// ═══════════════════════════════════════════════════════════
// CONFIGURACIÓN
// ═══════════════════════════════════════════════════════════

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value Json   // Permite almacenar cualquier configuración como JSON

  @@index([key])
  @@map("settings")
}

// ═══════════════════════════════════════════════════════════
// DOCUMENTACIÓN Y NOTAS DE IMPLEMENTACIÓN
// ═══════════════════════════════════════════════════════════

// FLUJO DE DOCUMENTOS:
// ───────────────────
// 1. PRESUPUESTO: DRAFT → SENT → APPROVED/CANCELLED/EXPIRED
// 2. RECIBO: DRAFT → SENT → APPROVED → COMPLETED/CANCELLED
// 3. REMITO: DRAFT → SENT → COMPLETED

// CONVERSIONES:
// ──────────────
// PRESUPUESTO (APPROVED) → RECIBO → REMITO
// - Los datos se copian como snapshot
// - Se mantiene relación via convertedFromId

// CÁLCULO DE BALANCE:
// ──────────────────
// - Se calcula en el backend al actualizar amountPaid
// - Formula: balance = total - amountPaid
// - Validar que amountPaid <= total
// - Si balance < 1 peso, redondear a 0

// RECARGOS POR CUOTAS (PaymentMethod):
// ────────────────────────────────────
// - CONTADO: 0%
// - CUOTAS_3: +18%
// - CUOTAS_6: +25%
// - CUOTAS_9: +35%
// - CUOTAS_12: +47%

// TIEMPOS DE ENTREGA:
// ──────────────────
// - STOCK: Inmediato
// - CATALOGO: 7-10 días hábiles

// MANEJO DE STOCK:
// ───────────────
// - Al marcar RECIBO como COMPLETED, descontar stock automáticamente
// - Solo para items con source = STOCK
// - Usar transacciones para evitar inconsistencias

// ÍNDICES:
// ────────
// - Optimizados para las queries más frecuentes
// - Consultas por fecha (DESC para más recientes primero)
// - Consultas combinadas (type + status)
// - Búsquedas de clientes por teléfono y nombre
// - Nuevo índice para paymentMethod

// VALIDACIONES DE NEGOCIO EN EL BACKEND:
// ─────────────────────────────────────
// ✅ No permitir eliminar documentos COMPLETED
// ✅ No permitir cambiar status de CANCELLED
// ✅ No permitir amountPaid > total
// ✅ Calcular balance automáticamente
// ✅ Validar paymentType solo en RECIBO
// ✅ Descontar stock al completar
// ✅ Validar que paymentMethod coincida con installments